{% extends "base.html" %}

{% block content %}
<div class="bg-white p-6 sm:p-8 rounded-xl shadow-md border border-gray-200">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">Historial de Constancias</h2>
            <p class="text-gray-500 text-sm">Administra y descarga los certificados generados.</p>
        </div>
        <a href="{% url 'users:crear_lote' %}" class="bg-empresa-green text-white font-bold py-2 px-4 rounded-lg mt-4 sm:mt-0 hover:bg-opacity-90 transition">+ Generar Nuevas</a>
    </div>

    <form method="GET" class="mb-6 flex gap-2">
        <input type="text" name="q" value="{{ busqueda }}" placeholder="Buscar por nombre de participante..." 
               class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-empresa-green">
        {% if filtro_activo %}
            <input type="hidden" name="tipo" value="{{ filtro_activo }}">
        {% endif %}
        <button type="submit" class="bg-gray-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black">Buscar</button>
        {% if busqueda %}
            <a href="?{% if filtro_activo %}tipo={{ filtro_activo }}{% endif %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold flex items-center">Limpiar</a>
        {% endif %}
    </form>

    <form method="post" id="batch-form">
        {% csrf_token %}

        <div id="action-bar" class="hidden bg-gray-50 p-4 rounded-lg my-4 items-center gap-4 border border-gray-200 sticky top-4 z-30 shadow-sm">
            <input type="checkbox" id="select-all" class="h-5 w-5 rounded text-empresa-green">
            <span id="selection-count" class="font-bold text-gray-700 flex-1"></span>
            
            <div class="flex gap-2">
                <button type="submit" formaction="{% url 'users:descargar_constancias_zip' %}" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    ZIP
                </button>

                <button type="submit" formaction="{% url 'users:borrar_constancias' %}" 
                        onclick="return confirm('¿Estás completamente seguro de eliminar las constancias seleccionadas? Esta acción no se puede deshacer.')"
                        class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Eliminar
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-6">
            {% for constancia in page_obj %}
            <div class="bg-white rounded-lg border border-gray-200 shadow-md p-5 flex flex-col justify-between hover:border-empresa-green transition relative">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Participante:</p>
                        <h3 class="font-bold text-gray-800">{{ constancia.participante.nombre_completo }}</h3>
                        <p class="text-xs text-blue-600">{{ constancia.participante.email }}</p>
                    </div>
                    <input type="checkbox" name="constancia_ids" value="{{ constancia.pk }}" class="h-6 w-6 rounded border-gray-300 text-empresa-green constancia-checkbox">
                </div>
                <div class="mt-4">
                    <p class="text-xs text-gray-500">Curso:</p>
                    <p class="text-sm font-semibold text-gray-700">{{ constancia.curso.nombre }}</p>
                </div>
                <div class="mt-4 flex gap-2">
                    <a href="{% url 'users:generar_pdf' constancia.pk %}" class="flex-1 bg-gray-100 text-gray-700 text-center py-2 rounded-lg font-bold hover:bg-gray-200 transition">Ver PDF</a>
                </div>
            </div>
            {% empty %}
                <div class="col-span-full py-12 text-center text-gray-500">
                    No se encontraron constancias que coincidan con tu búsqueda.
                </div>
            {% endfor %}
        </div>
    </form>

    {% if page_obj.paginator.num_pages > 1 %}
    <div class="flex flex-col items-center mt-12 mb-6">
        <div class="inline-flex items-center bg-white border border-gray-300 rounded-lg overflow-hidden">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if filtro_activo %}&tipo={{ filtro_activo }}{% endif %}{% if busqueda %}&q={{ busqueda }}{% endif %}" 
                   class="px-4 py-2 border-r border-gray-300 hover:bg-gray-100 text-gray-700 font-bold">Anterior</a>
            {% endif %}

            <span class="px-6 py-2 text-gray-700 font-medium">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if filtro_activo %}&tipo={{ filtro_activo }}{% endif %}{% if busqueda %}&q={{ busqueda }}{% endif %}" 
                   class="px-4 py-2 border-l border-gray-300 hover:bg-gray-100 text-gray-700 font-bold">Siguiente</a>
            {% endif %}
        </div>
        <p class="text-xs text-gray-400 mt-3">Total: {{ page_obj.paginator.count }} registros registrados.</p>
    </div>
    {% endif %}
</div>

<script>
    const checkboxes = document.querySelectorAll('.constancia-checkbox');
    const selectAll = document.getElementById('select-all');
    const actionBar = document.getElementById('action-bar');
    const selectionCount = document.getElementById('selection-count');
    const batchForm = document.getElementById('batch-form');

    let selectedIds = JSON.parse(localStorage.getItem('selected_constancias')) || [];

    function syncCheckboxes() {
        checkboxes.forEach(cb => {
            if (selectedIds.includes(cb.value)) {
                cb.checked = true;
            }
        });
        updateActionBar();
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', (e) => {
            if (e.target.checked) {
                if (!selectedIds.includes(e.target.value)) selectedIds.push(e.target.value);
            } else {
                selectedIds = selectedIds.filter(id => id !== e.target.value);
            }
            saveAndRefresh();
        });
    });

    selectAll.addEventListener('change', (e) => {
        checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
            if (e.target.checked) {
                if (!selectedIds.includes(cb.value)) selectedIds.push(cb.value);
            } else {
                selectedIds = selectedIds.filter(id => id !== cb.value);
            }
        });
        saveAndRefresh();
    });

    function saveAndRefresh() {
        localStorage.setItem('selected_constancias', JSON.stringify(selectedIds));
        updateActionBar();
    }

    function updateActionBar() {
        const totalCount = selectedIds.length;
        if (totalCount > 0) {
            actionBar.classList.replace('hidden', 'flex');
            selectionCount.textContent = `${totalCount} constancia(s) seleccionada(s)`;
        } else {
            actionBar.classList.replace('flex', 'hidden');
        }
    }

    // Al enviar el formulario (Borrar o Descargar)
    batchForm.addEventListener('submit', (e) => {
        document.querySelectorAll('.temp-input').forEach(el => el.remove());
        
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'constancia_ids'; 
            input.value = id;
            input.classList.add('temp-input');
            batchForm.appendChild(input);
        });

        // NOTA: Si es borrado, limpiaremos la memoria después del envío.
        // Como el navegador refrescará la página, solo necesitamos asegurarnos 
        // de que localStorage se limpie en la nueva carga.
        if (e.submitter && e.submitter.getAttribute('formaction').includes('borrar')) {
            localStorage.removeItem('selected_constancias');
        }
    });

    syncCheckboxes();
</script>
{% endblock content %}